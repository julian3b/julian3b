        // -// --- addworldchat ---
        try
        {
            if (!string.IsNullOrWhiteSpace(action) &&
                action.Equals("addworldchat", StringComparison.OrdinalIgnoreCase))
            {
                // ----------------------------
                // 0) Check streaming preference FIRST
                // ----------------------------
                var streamParam = ReadParam("stream");
                bool shouldStream = !string.Equals(streamParam, "false", StringComparison.OrdinalIgnoreCase);

                // ----------------------------
                // 1) Validation
                // ----------------------------
                if (string.IsNullOrWhiteSpace(email))
                    return await Json(req, HttpStatusCode.BadRequest, new { ok = false, error = "email is required." });
                var worldId = ReadParam("worldid") ?? ReadParam("worldId") ?? ReadParam("id");
                if (string.IsNullOrWhiteSpace(worldId))
                    return await Json(req, HttpStatusCode.BadRequest, new { ok = false, error = "worldId (id) is required." });
                var userText = ReadParam("text");
                if (string.IsNullOrWhiteSpace(userText))
                    return await Json(req, HttpStatusCode.BadRequest, new { ok = false, error = "text is required." });
                // ----------------------------
                // 2) Collect overrides
                // ----------------------------
                var o_model = ReadParam("model");
                var o_temp = ReadParam("temperature");
                var o_maxTok = ReadParam("maxTokens");
                var o_resp = ReadParam("responseStyle");
                var o_conv = ReadParam("conversationStyle");
                var o_pers = ReadParam("customPersonality");
                var o_chars = ReadParam("characters");
                var o_events = ReadParam("events");
                var o_scenario = ReadParam("scenario");
                var o_places = ReadParam("places");
                var o_add = ReadParam("additionalSettings");
                // ----------------------------
                // 3) Kick off parallel tasks (LEAN)
                // ----------------------------
                var latestSliceTask = _worldSummaries.GetLatestSliceAsync(email!, worldId!);
                var chatPageTask = _worldChats.ListByWorldAsync(email!, worldId!, 24, null);
                var worldTask = _worlds.GetAsync(email!, worldId!);
                var sessionTask = _sessions.GetOrCreateSessionAsync(email!, worldId!);
                // ----------------------------
                // 4) Await minimal required info
                // ----------------------------
                var chatPage = await chatPageTask;
                if (chatPage.error is not null)
                    return await Json(req, HttpStatusCode.BadGateway, new { ok = false, error = chatPage.error });
                var latestSlice = await latestSliceTask;
                // ----------------------------
                // 5) Summarize story quickly (latest slice only)
                // ----------------------------
                var condensedStory = (latestSlice.summaryText ?? "").Trim();
                if (condensedStory.Length > 600) condensedStory = condensedStory[..600];
                var summarizedCutoff = latestSlice.toUtc;
                // ----------------------------
                // 6) Windowed chat context (tighter/faster)
                // ----------------------------
                var rows = chatPage.pageItems ?? new List<WorldChatRow>();
                var windowed = rows
                    .Where(r => summarizedCutoff == default || r.CreatedUtc > summarizedCutoff)
                    .OrderByDescending(r => r.CreatedUtc)
                    .Take(8)
                    .OrderBy(r => r.CreatedUtc)
                    .ToList();
                // ----------------------------
                // 7) World + settings
                // ----------------------------
                var worldRow = await worldTask;
                var baseSettings = worldRow?.WorldSettings is not null
                    ? new UserSettings(
                        Model: worldRow.WorldSettings.Model ?? "",
                        Temperature: worldRow.WorldSettings.Temperature ?? 0.7,
                        MaxTokens: worldRow.WorldSettings.MaxTokens ?? 1024,
                        ResponseStyle: worldRow.WorldSettings.ResponseStyle ?? "",
                        ConversationStyle: worldRow.WorldSettings.ConversationStyle ?? "",
                        CustomPersonality: worldRow.WorldSettings.CustomPersonality ?? "")
                    : UserSettings.Defaults;
                var settings = MergeSettings(baseSettings, o_model, o_temp, o_maxTok, o_resp, o_conv, o_pers);
                // ----------------------------
                // 8) Context + system prompt (compact)
                // ----------------------------
                var sbCtx = new StringBuilder("You are roleplaying in this world. Stay in character. Never break voice.");
                if (!string.IsNullOrWhiteSpace(worldRow?.Name)) sbCtx.Append($" World Name: {worldRow.Name.Trim()}.");
                if (!string.IsNullOrWhiteSpace(worldRow?.WorldSettings?.ConversationStyle)) sbCtx.Append($" Conversation Style: {worldRow.WorldSettings.ConversationStyle.Trim()}.");
                if (!string.IsNullOrWhiteSpace(worldRow?.WorldSettings?.CustomPersonality)) sbCtx.Append($" Personality: {worldRow.WorldSettings.CustomPersonality.Trim()}.");
                if (!string.IsNullOrWhiteSpace(worldRow?.WorldSettings?.Scenario?.ToString())) sbCtx.Append($" Premise: {worldRow.WorldSettings.Scenario.ToString()!.Trim()}.");
                if (!string.IsNullOrWhiteSpace(o_scenario)) sbCtx.Append($" Current Situation: {o_scenario.Trim()}.");
                if (!string.IsNullOrWhiteSpace(o_events)) sbCtx.Append($" Recent Events: {o_events.Trim()}.");
                if (!string.IsNullOrWhiteSpace(o_chars)) sbCtx.Append($" Characters: {o_chars.Trim()}.");
                if (!string.IsNullOrWhiteSpace(o_places)) sbCtx.Append($" Important Locations: {o_places.Trim()}.");
                if (!string.IsNullOrWhiteSpace(o_add)) sbCtx.Append($" Behavioral Rules: {o_add.Trim()}.");
                var sys = new StringBuilder()
                    .AppendLine(BuildSystemPrompt(settings))
                    .AppendLine(sbCtx.ToString().Trim())
                    .AppendLine()
                    .AppendLine("Canon (latest slice only):")
                    .AppendLine(string.IsNullOrWhiteSpace(condensedStory) ? "(none)" : condensedStory)
                    .AppendLine()
                    .AppendLine("Response rules:")
                    .AppendLine("- Stay in character.")
                    .AppendLine("- Max 120 words.")
                    .AppendLine("- Do not restate past events unless necessary.")
                    .AppendLine()
                    .AppendLine("<ARC_SCENE_METADATA>")
                    .AppendLine("{\"mode\":\"CONTINUE_EXISTING_SCENE|NEW_SCENE_IN_EXISTING_ARC|NEW_ARC_AND_SCENE\",")
                    .AppendLine(" \"arcTitle\":\"short arc title or current arc title\",")
                    .AppendLine(" \"sceneTitle\":\"short scene title\",")
                    .AppendLine(" \"arcSummary\":\"1-2 sentence arc summary\",")
                    .AppendLine(" \"sceneSummary\":\"1-2 sentence scene summary\"}")
                    .AppendLine("</ARC_SCENE_METADATA>")
                    .ToString();
                // ----------------------------
                // 9) Prepare messages
                // ----------------------------
                var llmMsgs = new List<object> { new { role = "system", content = sys } };
                foreach (var turn in windowed)
                {
                    if (!string.IsNullOrWhiteSpace(turn.Input))
                        llmMsgs.Add(new { role = "user", content = turn.Input!.Trim() });
                    if (!string.IsNullOrWhiteSpace(turn.AiReply))
                        llmMsgs.Add(new { role = "assistant", content = turn.AiReply!.Trim() });
                }
                llmMsgs.Add(new { role = "user", content = userText!.Trim() });
                // ----------------------------
                // 10) NON-STREAMING PATH (for Replit)
                // ----------------------------
                if (!shouldStream)
                {
                    _logger.LogInformation("Non-streaming addworldchat: {Model} / {Msgs}", settings.Model, llmMsgs.Count);
                    var (nonStreamReply, nonStreamError) = await CallOpenAIWithMessagesAsync(llmMsgs, settings);
                    if (nonStreamError is not null)
                        return await Json(req, HttpStatusCode.BadGateway, new { ok = false, error = nonStreamError });
                    var session = await sessionTask ?? new WorldSessionState { Email = email!, WorldId = worldId! };
                    var (mode, arcTitle, sceneTitle, arcSummary, sceneSummary) = ParseMetadata(nonStreamReply ?? "");
                    var (arcId, sceneId) = await EnsureArcSceneAsync(
                        email!, worldId!, session, mode, arcTitle, sceneTitle, arcSummary, sceneSummary
                    );
                    session.ArcId = arcId ?? "00000";
                    session.SceneId = sceneId ?? "00000"; ;
                    await _sessions.UpdateSessionAsync(session);
                    var snapshot = new
                    {
                        Model = settings.Model,
                        Temperature = settings.Temperature,
                        MaxTokens = settings.MaxTokens,
                        ArcTitle = arcTitle,
                        SceneTitle = sceneTitle
                    };
                    await _worldChats.AddAsync(new WorldChatCreate
                    {
                        Email = email!,
                        WorldId = worldId!,
                        ArcId = session.ArcId,
                        SceneId = session.SceneId,
                        Input = userText!,
                        AiReply = nonStreamReply ?? "",
                        WorldSettings = JsonSerializer.Serialize(snapshot),
                        CreatedUtc = DateTimeOffset.UtcNow
                    });
                    return await Json(req, HttpStatusCode.OK, new { ok = true, ai = new { reply = nonStreamReply } });
                }
                // ----------------------------
                // 11) STREAMING PATH (for local dev - kept for compatibility)
                // ----------------------------
                _logger.LogInformation("Streaming mode disabled - using non-streaming fallback");
                var (streamReply, streamError) = await CallOpenAIWithMessagesAsync(llmMsgs, settings);
                if (streamError is not null)
                    return await Json(req, HttpStatusCode.BadGateway, new { ok = false, error = streamError });
                var streamSession = await sessionTask ?? new WorldSessionState { Email = email!, WorldId = worldId! };
                var (streamMode, streamArcTitle, streamSceneTitle, streamArcSummary, streamSceneSummary) = ParseMetadata(streamReply ?? "");
                var (streamArcId, streamSceneId) = await EnsureArcSceneAsync(
                    email!, worldId!, streamSession, streamMode, streamArcTitle, streamSceneTitle, streamArcSummary, streamSceneSummary
                );
                streamSession.ArcId = streamArcId;
                streamSession.SceneId = streamSceneId;
                await _sessions.UpdateSessionAsync(streamSession);
                var streamSnapshot = new
                {
                    Model = settings.Model,
                    Temperature = settings.Temperature,
                    MaxTokens = settings.MaxTokens,
                    ArcTitle = streamArcTitle,
                    SceneTitle = streamSceneTitle
                };
                await _worldChats.AddAsync(new WorldChatCreate
                {
                    Email = email!,
                    WorldId = worldId!,
                    ArcId = streamArcId,
                    SceneId = streamSceneId,
                    Input = userText!,
                    AiReply = streamReply ?? "",
                    WorldSettings = JsonSerializer.Serialize(streamSnapshot),
                    CreatedUtc = DateTimeOffset.UtcNow
                });
                return await Json(req, HttpStatusCode.OK, new { ok = true, ai = new { reply = streamReply } });
            }
        }
        catch (Exception ex) {
            Console.Write(ex);
        }
